import std/[times]
import rtthread, jill, jill/ringbuffer, jill/os, keym/codes, jacket

type
  KeyboardEvent {.packed.} = object
    usec: int64
    note: int8
    on: bool

const
  keyboardEventPriority = 96
  keyboardPath = "/dev/input/event3"

var
  signalThread:Thread[void]
  keyboardEventBuffer = newRingBuffer[KeyboardEvent](2048)
  keyboardEventThread:Thread[void]
  terminating = false

let
  keyboardDevice = openDevice(keyboardPath) 


createThread signalThread, proc() {.thread.} =
  waitSignals(SIGABRT, SIGHUP, SIGINT, SIGQUIT, SIGTERM):
    terminating = true

blockSignals(SIGABRT, SIGHUP, SIGINT, SIGQUIT, SIGTERM)

createRealtimeThread(keyboardEventThread, keyboardEventHandler)

#setSignalProc(signalHandler, SIGABRT, SIGHUP, SIGINT, SIGQUIT, SIGTERM)

var count = 0

withJack (), (foo), defaultClientName(), false:
  var
    jackTimeUsec: int64 
    sysTimeUsec: int64
    sysTimeOffset: int64

    currentEvent: KeyboardEvent

    currentFrame: uint32
    currentFrameUsec: int64
    currentFrameUsecUnsigned: uint64
    nextFrameUsec: int64
    nextFrameUsecUnsigned: uint64
    periodUsec: float32

  if count == 0:
    sysTimeUsec = getSysTimeUsec()
    jackTimeUsec = jacket.getTime().int64
    sysTimeOffset = sysTimeUsec - jackTimeUsec
    count = 10
  else:
    count -= 1
  if getCycleTimes(client, currentFrame.addr, currentFrameUsecUnsigned.addr, nextFrameUsecUnsigned.addr, periodUsec.addr) == 0:
    while keyboardEventBuffer.pop(currentEvent):
      currentFrameUsec = currentFrameUsecUnsigned.int64
      nextFrameUsec = nextFrameUsecUnsigned.int64
      let currentEventUsec = currentEvent.usec.int64 - sysTimeOffset
      let currentEventFrame = client.timeToFrames(currentEventUsec.uint64)
      echo [sysTimeOffset, currentFrameUsec, currentEventUsec, currentEventUsec - currentFrameUsec]
  for i in 0..<64:
    foo[i] = 0.0

joinThread(keyboardEventThread)

#proc calculateFrame(event: KeyboardEvent, frameZeroTime: Time, numFrames: int): int =

#proc apply(samples: var openArray[SomeFloat], events: openArray[KeyboardEvent], frameZeroTime: Time) =


